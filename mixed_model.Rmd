---
title: "Exploring the seasonal variation in electric vehicle charging in New Zealand"
author: "Pablo Paulsen"
date: "18/02/2022"
output:
  pdf_document:
    fig_caption: yes
    keep_tex: yes
header-includes:
- \usepackage{float}
- \floatplacement{figure}{H}
- \usepackage{comment}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
knitr::opts_chunk$set(fig.width=9, fig.height=5) 
#knitr::opts_chunk$set(fig.pos = 'H')
library(tidyverse)
library(latex2exp)
library(lmerTest)
library(tseries)
library(pander)
library(optimx)
library(knitr)
library(nlme)
library(lme4)

rm(list=ls())
```

```{r functions, include = FALSE}
source("functions/yearly_line.R")
source("functions/plot_ts_decomp.R")
```


```{r graph_option, include = FALSE}
#ggplot styling
gg_theme = theme_bw(base_size = 14)
gg_color_palette = scale_color_brewer(palette = "Set1")

#base r stylings
legend_inset = c(0.020, 0.036)
margins = list(mar = c(3, 4, 1, 1))
```

```{r ev_data_setup, message = FALSE}
load("processed_data/EV_weather_data.rda")
#attach(EV_data)
```

```{r fuel_data, message = FALSE}
#MBIE quaterly fuel usage data
fuel_trade = read.csv("downloaded_stats/fuel_trade.csv", header = T)
fuel_trade$qart = fuel_trade$month/3
```

```{r VKT_data, message = FALSE}
load("processed_data/VKT_data.rda")
```

```{r model_results, message = FALSE}
load("processed_data/power_usage.rda")
```


\begin{equation}
\label{eq1}
E_{m,R} = \eta_{m,R} \times d_{m,R}
\end{equation}

\ref{eq1}

## Data Exploration 

### Flip the Fleet Data Exploration

Distance traveled and vehicle energy efficiency (km/kWh) by month, as well as the region of the vehicle was collected from the on-board computers of `r length(unique(EV_data$vehicle))` electric vehicles (EV) between `r min(EV_data$year)` and `r max(EV_data$year)` by Flip the Fleet \cite{ftf}. 

Energy economy (Wh/km) was calculated as the inverse of efficiency (km/kWh). Energy economy will be used instead of efficiency in the modelling in this work for reasons that will become apparent later in the analysis. 

A monthly weighted average energy economy was calculated for the whole of New Zealand and then for each region. The monthly averages were weighted using the distance traveled to give more weighting to vehicles with higher km traveled in that month. This was done using the formula

$$\bar{x} = \frac{\sum_{i}^{n} (d_i\times x_i)}{\left(\sum_{i}^{n} d_i\right)\times n}$$



```{r consum_plot, fig.cap="National monthly average energy economy of Flip the Fleet vehicles\\label{fig:consum_plot}"}
par(mar = c(4.5, 4, 1, 1))
plot(monthly_EV_data$m, monthly_EV_data$mean_consum, type = 'l', xaxt = "n", xlab = "", ylab = "Monthly National Average Energy Economy (Wh/km)", las = 1)
axis(1,labels = paste(monthly_EV_data$year, monthly_EV_data$month, sep = "-"), at = monthly_EV_data$m, las = 2,srt = 35)
yearly_line()
```


Figure \ref{fig:consum_plot} shows there is a clear seasonal trend in the national monthly average energy economy of Flip the Fleets vehicles. 

A time series decomposition is used to isolate the seasonal trend in energy economy from the overall trend. This can be done for all regions of NZ combined and also for each region individually. 


```{r consum_decomp_plot, fig.cap="Multiplicative time series decomposition of Flip the Fleet average energy economy for all of NZ\\label{fig:consum_decomp_plot}", fig.height=6, message=FALSE, warning=FALSE}
decomp_consum = monthly_EV_data$mean_consum %>% 
  ts(frequency = 12, start = 2017) %>% 
  decompose("multiplicative")

plot_decomp(decomp_consum, title = "", ylab = "Energy Economy (Wh/km)")
```


```{r acf_consum, fig.cap="Autocorrelation plot of Flip the Fleet average energy economy for all of NZ\\label{fig:acf_consum}"}
par(margins)
acf(decomp_consum$x, main = "")
```

The time series decomposition (Figure \ref{fig:consum_decomp_plot}) shows a very clear seasonal trend. The autocorrelation plot (Figure \ref{fig:acf_consum}) shows that this yearly trend is significant. This seasonal trend goes from `r signif(min(decomp_consum$figure),2)` times the mean energy economy in February to `r round(max(decomp_consum$figure),2)` times the mean energy economy in July, a peak to peak difference of `r  round(abs(max(decomp_consum$figure)/min(decomp_consum$figure)-1)*100, 1)`\%. 

<!-- may add reference of linking range to temp if not mentioned in the intro -->
Past research shows that a majority of the seasonal variation in EV efficiency is due to cabin temperature control\cite{ev_range}. This would suggest that EV energy economy is correlated with heating degree days. To test this hypothesis, as NZ weather differs significantly by region, we must limit the comparison to a single region and compare it to that regions weather at the same period of time.

In order to do this, hourly weather data from 2017 to 2021 was collected from the NIWA National Climate Database for `r length(levels(CDD_data$City))` regions around New Zealand that best correspond to the regions of the Flip the Fleet vehicles. Using the regional hourly temperatures, monthly heating degree days (HDD) and cooling degree days (CDD) were imputed using base temperatures of 16$^\circ$C and 22$^\circ$C respectively. These base temperatures were selected to represent the range of comfortable temperatures for most people. Monthly average temperature were also calculated.

The HDD and CDD was then divided by the length of the month to determine to average heating/cooling degrees days per day for the month. This is so that when comparing to other statistics, such as efficiency that are averaged out rather than summed, there is less bias.

The calculated monthly weather statistics by region was then compared to the monthly EV data based on the regions of vehicle. This assumes that most vehicles stay in their own region for a majority of the time. 


```{r consum_HDD_plot, fig.cap = "Auckland seasonal HDD and EV energy economy decompostions\\label{fig:consum_HDD_plot}", warning = FALSE}
auck_consum_series = ts(monthly_reg_EV_data$mean_consum[which(monthly_reg_EV_data$weather_region == "Auckland")], frequency = 12)
decomp_auck_consum = decompose(auck_consum_series,"multiplicative")
auck_HDD_series = ts(monthly_reg_EV_data$HDD[monthly_reg_EV_data$weather_region == "Auckland"], frequency = 12)
decomp_auck_HDD = decompose(auck_HDD_series,"multiplicative")

par(mar = c(3, 4, 1, 4))
plot(decomp_auck_consum$figure, type = 'b', xaxt = "n",
     xlab = "", ylab = "Proportinal Change in Energy Economy", las = 1)
axis(1, labels = month.abb, at = 1:12, las = 1)

par(new=TRUE)
plot(decomp_auck_HDD$figure, type = 'b', col = 2, xlab="", ylab="",axes=FALSE)
mtext("Average Heating Degree (째 Days per Day) (Base temp 16째C)", side=4, line=2, cex = 1, padj = 1, col = 1) 
axis(4, las = 1, col = 2, col.axis = 2)

legend("topright", inset = legend_inset, legend = c("EV Energy Economy", "HDD"), lty = 1, col = 1:2, pch = 1)
```


Auckland is used as an example to compare correlation between HDD and energy economy as it has the largest amount of data and is of most interest to Vector. Within Auckland, Figure \ref{fig:consum_HDD_plot} shows very clearly that HDD and energy economy of EVs are highly correlated. There is a slight increase in energy economy in January and February and it can be questioned if that is due to AC usage which would decrease range \cite{ev_range} or other factors such as holiday travel, often involving highway driving which EVs are generally less efficient at \cite{ev_highway}. This effect is not obvious in the overall trend for NZ, so due to the fact that Auckland for the most part is a warmer climate than the rest of NZ.


```{r temp_consum_plot, fig.cap = "Auckland monthly average energy economy by avg temperature\\label{fig:temp_consum_plot}", message=FALSE}
monthly_reg_EV_data[monthly_reg_EV_data$weather_region == "Auckland",] %>%
  ggplot(aes(avg_temp, mean_consum)) +
    labs(y="Monthly Average Energy Economy (Wh/km)", x="Monthly Average Temperature (째C)") +
    geom_smooth(method = 'loess') +
    geom_point() +
    gg_theme
```


Further exploring the relation between energy economy and weather in Auckland, Figure \ref{fig:temp_consum_plot} shows a decreasing energy economy up to around a monthly average temperature of 17.5째C. However, increasing monthly average temperature past this, there appears to be a trend towards increasing EV energy economy. As stated previously, research \cite{ev_range} suggested AC also increases energy economy of EVs. This suggests it may be worth including both cooling degree days and heating degree days in the analysis. This could also be useful to explain the points well above the trend line that may be from a month where there was both cold and warm days contributing to a high usage of cabin temperature control, increasing energy economy, but average temperature would not be able to show this. 


### NZ VKT Data Exploration

To determine the season impacts of EV charging on our electricity grid we also need to explore seasonality in driving patterns. A number of data sets were considered including fuel usage and vehicle kilometers traveled (VKT) data.


<!-- should i include info on fuel data collected? -->

<!-- 3 fuel usage data sets were collected to analyze the fuel usage trend. -->
<!-- \begin{itemize} -->
<!--   \item monthly card sales data  -->
<!--   \begin{itemize} -->
<!--     \item monthly data for all of NZ credit card transactions at fuel stations -->
<!--   \end{itemize} -->
<!--   \item quarterly regional fuel sales data -->
<!--   \begin{itemize} -->
<!--     \item quarterly data for all sales at fuel stations broken down by region from MBIE -->
<!--   \end{itemize} -->
<!--   \item quarterly fuel trade data -->
<!--     \begin{itemize} -->
<!--     \item quarterly data of fuel used for transport by type of fuel -->
<!--   \end{itemize} -->
<!-- \end{itemize} -->

To explore the seasonal trend in fuel usage in NZ, fuel trade data \cite{fuel_trade} from the Ministry of Business, Innovation and Employment (MBIE) is used. This data set includes quarterly fuel usage data broken down by fuel type and sector. This allows the isolation of petrol usage in domestic land transport, which should provide an estimate of the fuel usage by light passenger vehicles. Fuel trade data from 2020 was excluded as lockdowns were not an accurate representation of the general driving patterns of the NZ population.


```{r petrol_ts, fig.cap="Multiplicative time series decomposition of petrol usage in domestic land transport\\label{fig:petrol_ts}", warning=FALSE, message=FALSE, fig.height=6}
decomp_petrol = fuel_trade$Petrol[fuel_trade$year < 2020] %>% 
  ts(frequency = 4, start = min(fuel_trade$year)) %>% 
  decompose("multiplicative")
  
plot_decomp(decomp_petrol, ylab = "Fuel usage (L)")
```


Figure \ref{fig:petrol_ts} time series decomposition shows a seasonal trend in petrol usage, however, it is of relatively small magnitude compared to the random variations suggesting this trend may not be significant.


```{r acf_petrol, fig.cap="Autocorrelation of petrol usage in domestic land transport\\label{fig:acf_petrol}"}
par(margins)
acf(decomp_petrol$x, main = "")
```


The autocorrelation plot (figure \ref{fig:acf_petrol}) suggest that there might be a slight trend in petrol usage however it does not appear to be of much significance. 


Fuel trade data can be compared to the VKT data from the Ministry of Transport. VKT data including quarterly data of 10 regions plus one "other" region was given by Haobo Wang from the Ministry of Transport for use in this project. Further yearly data for VKT of the "other" regions, the vehicle fuel type and vehicle type was collected from the publicly available fleet statistics page on Ministry of Transport's website. The quarterly VKT data was then multiplied by the proportion of VKT that was attributed to light passenger vehicles in that year.

```{r VKT_ts, fig.cap="Decomposition of NZ all regions passenger VKT Time Series\\label{fig:VKT_ts}", warning=FALSE, message=FALSE, fig.height=6}
decomp_vkt = vkt_quart_pass[vkt_quart_pass$year >= 2003,]$total %>% 
  ts(frequency = 4, start = min(2003)) %>% 
  decompose("multiplicative")

plot_decomp(decomp_vkt, ylab = "Million km travelled", breaks = 10)
```


Figure \ref{fig:VKT_ts} shows the time-series decomposition of the NZ total VKT data shows a clear seasonal trend, albeit smaller than the trend from the fuel sales data. There is, however, clearly a large amount of smoothing going on with this data. This is shown in a couple of different ways including:

\begin{itemize}
\item The drop of VKT due to lockdown which started in 2020 March is already visible in the data from early 2019. 
\item Related to the previous point, the Random component of Time Series Decomposition shows only a 10\% decrease in VKT spread out over a 1 year period from lockdown, compared to 30\% drop in fuel usage during only 1 quarter shown in the MIBE fuel trade data. 
\item Random variation in MIBE fuel trade data shows around a 3 times greater random variation. There could be a seasonal effect on fuel efficiency which could change the seasonal fuel trend relative to VKT, but there is no reason there would be any significant randomness in fuel efficiency so randomness should be of similar magnitude.
\end{itemize}

This smoothing likely occurs due to the method of VKT data collection using the odometer readings during WoF/CoF. For a majority of vehicles WoF is only done once a year and in the case of new cars that could be up to 3 years. This likely causes the data to show less seasonal trend than may exist in the real world.

Looking at the long term trend, VKT remained largely flat between 2004 and 2012 after which there was a steady but significant increase until 2019. After this, there is a decrease in VKT due to lockdown, which in this data set for the above reasons likely started showing its effects in 2019. 


```{r petrol_VKT_vs_eff, fig.cap="NZ Seasonal Component Decompostions"}
par(margins)
plot(decomp_consum$figure, type = 'b', xaxt = "n",
     xlab = "", ylab = "Proportional Change", las = 1)
axis(1, labels = month.abb, at = 1:12, las = 1)

points(unique(fuel_trade$month)-1,decomp_petrol$figure, type = 'b', col = 2, xlab="", ylab="")

points(c(2,5,8,11), decomp_vkt$figure, type = 'b', col = 3, xlab="", ylab="")

legend("topright", inset = legend_inset, legend = c("EV Energy Economy", "Petrol Usage", "Ministry of Transport VKT"), lty = 1,pch = 1, col = 1:3)
```


Looking at the Seasonal trend of Petrol Usage and VKT data from Ministry of Transport, we can see an obvious decrease in the winter months with a peak in the 4th quarter likely corresponding to holiday travel. Petrol Usage shows this variation to be much larger in the VKT data from Ministry of Transport. It is unclear whether this would be due to the smoothing effect as was previously discussed regarding the Ministry of Transport data, or perhaps a change in efficiency for petrol vehicle by seasons similar to that of the EV. Combining these 2 data sets it is reasonable to suggest that in New Zealand, compared to the winter (Q2 and Q3) VKT, the true VKT in the summer (Q1 and Q4) is between `r round((mean(decomp_vkt$figure[c(4,1)])/mean(decomp_vkt$figure[2:3])-1)*100,1)`\% higher, as suggested by the VKT data from Ministry of Transport, to `r round((mean(decomp_petrol$figure[c(4,1)])/mean(decomp_petrol$figure[2:3])-1)*100,1)`\% higher, according to the petrol usage data.

Looking at the seasonal trend of EV energy economy we can see a much larger increase in energy economy in the winter months, with average energy economy in July being `r round(abs(max(decomp_consum$figure)/min(decomp_consum$figure)-1)*100, 1)`\% higher energy economy than in February. From the plot we can see that when energy economy of EVs increases, VKT goes down, suggesting that some increase in total power usage due to EVs increase in energy economy will be countered by a decrease in VKT. However, the increase in energy economy is much larger than the decrease in VKT. This, combined with the fact that winter is when our electricity grid in New Zealand is already under strain due to heating demand, suggests that if we ignore the relatively small change in VKT in our model we can effectively model a worst case scenario. Thus we propose that monthly distance ($d_{R}$) in our model is constant and determined by the yearly regional VKT data from 2019. 



```{r}
eff_lmm_model = lme(fixed = consumption ~ HDD + CDD + weather_region + model, random = ~ 1 | vehicle, na.action=na.omit, data = EV_data, control = lmeControl(opt = "optim"))
summary(eff_lmm_model)
```
```{r}
plot(eff_lmm_model)
```
```{r}
eff_hierc_model = lme(fixed = consumption ~ HDD + CDD + weather_region, random = list(~ 1 | model, ~1 | vehicle), na.action=na.omit, control = lmeControl(opt = "optim"), weights = varIdent(~1/distance), data = EV_data)
summary(eff_hierc_model)
```


```{r}
eff_lmm_model2 = lmer( consumption ~ HDD + CDD + weather_region + model + (1 | vehicle), data = EV_data[EV_data$distance !=0, ], weights = 1/distance)
summary(eff_lmm_model2)
```

```{r}
eff_hierc_model2 = lmer( consumption ~ HDD + CDD + weather_region + (1 | model/vehicle), data = EV_data[EV_data$distance >= 30, ], weights = 1/distance)
summary(eff_hierc_model2)
#weighted hierarchical model appears to work only if excluding the cars with a small number of km driven in the month
```
```{r}
plot(eff_hierc_model2)
```


```{r}
eff_hierc_model$coefficients$fixed
```

```{r}
eff_hierc_model$coefficients$random$model
```

```{r}
varWeights(varFunc(~distance))
```

